질문 (원본):
2025-10-28

질문: @# King - 건물주 (Building Owner) 
**학습해** 나는 방금 매월 반복하는 일정을 등록했다. 하지만 캘린더에는 해당 날짜만 나오고 다음 월에는 등록한 일정이 나오지 않는다. 오류를 찾고 수정해라.

답변:
건물주로서 매월 반복 일정이 다음 월에 나오지 않는 오류를 발견하고 수정했습니다.

## 🔍 문제 발견

### 근본 원인
**파일**: `src/hooks/useEventOperations.ts`

**문제**: 반복 일정을 저장할 때 `generateRecurringEvents` 함수를 호출하지 않음

```typescript
// ❌ 기존 코드 (문제)
const saveEvent = async (eventData: Event | EventForm) => {
  // ... 
  response = await fetch('/api/events', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(eventData),  // 단일 이벤트만 저장
  });
  // ...
};
```

**결과**:
- 사용자가 "매월 반복" 선택해도
- 단일 이벤트만 DB에 저장됨
- 다음 월의 반복 일정이 생성되지 않음 ❌

## ✅ 적용한 수정

### 수정 내용

**파일**: `src/hooks/useEventOperations.ts`

#### 1. Import 추가
```typescript
import { generateRecurringEvents } from '../utils/recurringEventUtils';
```

#### 2. saveEvent 함수 수정

```typescript
const saveEvent = async (eventData: Event | EventForm) => {
  try {
    let response;
    
    // Check if this is a repeating event
    // <!-- 반복 일정인지 확인 -->
    const isRepeatingEvent = eventData.repeat.type !== 'none' && !editing;
    
    if (editing) {
      // 수정 모드: 단일 이벤트 업데이트
      response = await fetch(`/api/events/${(eventData as Event).id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(eventData),
      });
    } else if (isRepeatingEvent) {
      // ⭐ 새로운 반복 일정: 모든 반복 인스턴스 생성
      // Generate recurring events
      // <!-- 반복 일정 생성 -->
      const tempEvent = { ...eventData, id: 'temp' } as Event;
      const recurringEvents = generateRecurringEvents(tempEvent);
      
      // Save all recurring events at once
      // <!-- 모든 반복 일정을 한 번에 저장 -->
      response = await fetch('/api/events-list', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ events: recurringEvents }),
      });
    } else {
      // 일반 일정: 단일 이벤트 저장
      response = await fetch('/api/events', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(eventData),
      });
    }

    if (!response.ok) {
      throw new Error('Failed to save event');
    }

    await fetchEvents();
    onSave?.();
    enqueueSnackbar(editing ? '일정이 수정되었습니다.' : '일정이 추가되었습니다.', {
      variant: 'success',
    });
  } catch (error) {
    console.error('Error saving event:', error);
    enqueueSnackbar('일정 저장 실패', { variant: 'error' });
  }
};
```

## 🎯 수정 로직 흐름

### Before (수정 전)
```
1. 사용자가 "매월 반복" 체크하고 일정 저장
2. eventData 객체 생성 (repeat.type = 'monthly')
3. /api/events로 POST → 단일 이벤트만 저장 ❌
4. 결과: 캘린더에 원본 날짜만 표시
```

### After (수정 후)
```
1. 사용자가 "매월 반복" 체크하고 일정 저장
2. eventData 객체 생성 (repeat.type = 'monthly')
3. isRepeatingEvent = true 감지 ✅
4. generateRecurringEvents(eventData) 호출 ✅
   → 매월 반복 일정 배열 생성
   → 예: 1월 15일, 2월 15일, 3월 15일, ...
5. /api/events-list로 POST → 모든 반복 일정 저장 ✅
6. 결과: 캘린더에 모든 월에 일정 표시 ✅
```

## 📊 처리하는 시나리오

### 1. 반복 없는 일반 일정
```typescript
eventData.repeat.type = 'none'
→ isRepeatingEvent = false
→ /api/events로 단일 이벤트 저장
```

### 2. 매일 반복
```typescript
eventData.repeat.type = 'daily'
eventData.repeat.interval = 1
eventData.repeat.endDate = '2025-02-15'
→ isRepeatingEvent = true
→ generateRecurringEvents() 호출
→ 1/1, 1/2, 1/3, ..., 2/15 생성
→ /api/events-list로 모두 저장
```

### 3. 매주 반복
```typescript
eventData.repeat.type = 'weekly'
eventData.repeat.interval = 1
eventData.repeat.endDate = '2025-01-29'
→ isRepeatingEvent = true
→ generateRecurringEvents() 호출
→ 1/1, 1/8, 1/15, 1/22, 1/29 생성
→ /api/events-list로 모두 저장
```

### 4. 매월 반복 ⭐
```typescript
eventData.repeat.type = 'monthly'
eventData.repeat.interval = 1
eventData.repeat.endDate = '2025-05-15'
→ isRepeatingEvent = true
→ generateRecurringEvents() 호출
→ 1/15, 2/15, 3/15, 4/15, 5/15 생성
→ /api/events-list로 모두 저장 ✅
```

### 5. 매년 반복
```typescript
eventData.repeat.type = 'yearly'
eventData.repeat.interval = 1
eventData.repeat.endDate = '2029-01-15'
→ isRepeatingEvent = true
→ generateRecurringEvents() 호출
→ 2025/1/15, 2026/1/15, 2027/1/15, 2028/1/15, 2029/1/15 생성
→ /api/events-list로 모두 저장
```

### 6. 수정 모드
```typescript
editing = true
→ isRepeatingEvent = false (수정은 반복 생성하지 않음)
→ /api/events/:id로 PUT
→ 해당 이벤트만 업데이트
```

## 🔧 서버 엔드포인트 활용

### 기존 엔드포인트 활용
**파일**: `server.js`

#### /api/events-list (POST)
이미 존재하는 엔드포인트로, 여러 이벤트를 한 번에 저장 가능
```javascript
app.post('/api/events-list', async (req, res) => {
  const events = await getEvents();
  const repeatId = randomUUID();
  const newEvents = req.body.events.map((event) => {
    const isRepeatEvent = event.repeat.type !== 'none';
    return {
      id: randomUUID(),
      ...event,
      repeat: {
        ...event.repeat,
        id: isRepeatEvent ? repeatId : undefined,
      },
    };
  });

  fs.writeFileSync(
    `${__dirname}/src/__mocks__/response/${dbName}`,
    JSON.stringify({
      events: [...events.events, ...newEvents],
    })
  );

  res.status(201).json(newEvents);
});
```

**특징**:
- 여러 이벤트를 배열로 받음 ✅
- 각 이벤트에 고유 ID 생성 ✅
- 반복 이벤트에 동일한 `repeat.id` 부여 ✅

## 💡 종료일 처리

### 종료일이 있는 경우
```typescript
eventData.repeat.endDate = '2025-05-15'
→ generateRecurringEvents()는 endDate까지만 생성
→ 결과: 제한된 개수의 이벤트
```

### 종료일이 없는 경우
```typescript
eventData.repeat.endDate = undefined
→ generateRecurringEvents()는 maxOccurrences(기본 365)까지 생성
→ 결과: 최대 365개 이벤트
```

**참고**: 향후 개선 사항으로 종료일 필수화 또는 기본 종료일 설정 고려

## 🎉 수정 결과

### Before (수정 전)
```
사용자: "매월 15일 팀 회의" 반복 일정 등록
결과: 
- 1월 캘린더: "팀 회의" 표시 ✅
- 2월 캘린더: 표시 없음 ❌
- 3월 캘린더: 표시 없음 ❌
```

### After (수정 후)
```
사용자: "매월 15일 팀 회의" 반복 일정 등록 (종료일: 5월 15일)
결과: 
- 1월 캘린더: "팀 회의" 표시 ✅
- 2월 캘린더: "팀 회의" 표시 ✅
- 3월 캘린더: "팀 회의" 표시 ✅
- 4월 캘린더: "팀 회의" 표시 ✅
- 5월 캘린더: "팀 회의" 표시 ✅
```

## 📝 학습 내용

### 문제 원인 (Learning Point)

**테스트 코드는 작성했지만 실제 UI와 연결하지 않음**

1. ✅ `generateRecurringEvents` 함수 구현 완료
2. ✅ 16개 테스트 모두 통과
3. ❌ 하지만 UI에서 이 함수를 호출하지 않음
4. ❌ 결과: 기능은 존재하지만 사용되지 않음

### 해결 방법

**구현 → 테스트 → 통합**

1. 유틸 함수 구현
2. 단위 테스트 작성 및 통과
3. **UI/Hook과 통합** ⭐ (이 단계가 누락되었음)
4. 통합 테스트로 전체 흐름 확인

### 앞으로 주의할 점

- [ ] 함수 구현 시 실제 사용처 확인
- [ ] 테스트 통과 ≠ 기능 완성
- [ ] UI와의 통합까지 완료해야 진짜 완성
- [ ] 통합 테스트로 전체 흐름 검증

## ✅ 최종 확인 사항

```
✓ generateRecurringEvents 함수 구현 완료
✓ 16개 단위 테스트 모두 통과
✓ useEventOperations에 반복 일정 저장 로직 추가 ✅
✓ /api/events-list 엔드포인트 활용
✓ 일반 일정 / 반복 일정 / 수정 모드 분기 처리
✓ Lint 오류 없음
```

이제 매월 반복 일정을 등록하면 다음 월에도 캘린더에 정상적으로 표시됩니다! 🎊

