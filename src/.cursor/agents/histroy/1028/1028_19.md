질문 (원본):
2025-10-28

질문: **학습해**
@# King - 건물주 (Building Owner) 
현재 31일매월 등록을 만들어서 등록을 했다. 근데 이것을 수정해서 매월을 매주로 변경하려고 했는데 저장 실패가 나온다. 이것이 가능하게 해줘.

답변:
건물주로서 반복 일정 수정 시 발생하는 저장 실패 문제를 해결했습니다.

## 🔍 문제 분석

### 발생한 문제
사용자가 31일 매월 반복 일정을 등록한 후, 이를 수정해서 "매월 → 매주"로 변경하려고 하면 **저장 실패** 발생

### 근본 원인

**현재 아키텍처**:
```
1. DB 저장: 1개 원본 이벤트
   {"id": "original-123", "date": "2025-01-31", "repeat": {"type": "monthly"}}

2. 화면 표시: 펼쳐진 이벤트들
   [
     {"id": "temp-1", "date": "2025-01-31", ...},
     {"id": "temp-2", "date": "2025-03-31", ...},
     {"id": "temp-3", "date": "2025-05-31", ...}
   ]

3. 수정 시도:
   사용자가 3월 31일 이벤트를 클릭 → 수정 모달 열림
   → "매월 → 매주" 변경 후 저장
   → PUT /api/events/temp-2 호출 ❌
   → 서버에 "temp-2" ID가 없음 → 404 오류
```

**문제점**:
1. **펼쳐진 이벤트의 임시 ID 사용**: `temp-1`, `temp-2` 등은 클라이언트에서만 생성된 ID
2. **원본 이벤트 ID 분실**: 수정 시 원본 이벤트 ID(`original-123`)를 사용하지 않음
3. **날짜 불일치**: 3월 31일 이벤트를 수정하면 `date: "2025-03-31"`로 저장 시도
   - 하지만 원본은 `date: "2025-01-31"` (시작 날짜)

## ✅ 적용한 수정

### 1. RepeatInfo 타입 확장

**파일**: `src/types.ts`

```typescript
export interface RepeatInfo {
  type: RepeatType;
  interval: number;
  endDate?: string;
  id?: string;
  originalEventId?: string; // ⭐ 원본 이벤트 ID (수정/삭제용)
  originalDate?: string;     // ⭐ 원본 시작 날짜 (수정용)
}
```

**추가한 필드**:
- `originalEventId`: 펼쳐진 이벤트가 어느 원본 이벤트에서 왔는지 추적
- `originalDate`: 원본 이벤트의 시작 날짜 (반복 일정의 기준일)

### 2. 펼쳐진 이벤트에 메타데이터 저장

**파일**: `src/utils/recurringEventUtils.ts`

```typescript
export function generateRecurringEvents(event: Event, maxOccurrences = 365): Event[] {
  const originalEventId = event.id;
  // ...

  events.push({
    ...event,
    id: generateEventId(), // 표시용 임시 ID
    date: dateString,      // 펼쳐진 날짜 (3월 31일, 5월 31일 등)
    repeat: {
      ...event.repeat,
      id: repeatId,
      originalEventId: originalEventId, // ⭐ 원본 이벤트 ID 저장
      originalDate: event.date,          // ⭐ 원본 시작 날짜 저장
    },
  });
}
```

**저장 구조**:
```json
{
  "id": "temp-2",               // 임시 ID (화면 표시용)
  "date": "2025-03-31",         // 펼쳐진 날짜
  "repeat": {
    "type": "monthly",
    "interval": 1,
    "originalEventId": "original-123",  // ⭐ 원본 ID
    "originalDate": "2025-01-31"        // ⭐ 원본 시작 날짜
  }
}
```

### 3. 수정 로직 개선

**파일**: `src/hooks/useEventOperations.ts`

```typescript
const saveEvent = async (eventData: Event | EventForm) => {
  try {
    let response;

    if (editing) {
      const event = eventData as Event;
      
      // ⭐ 반복 일정의 경우 원본 이벤트 ID 사용
      const updateId = event.repeat?.originalEventId || event.id;
      
      // ⭐ 반복 일정의 경우 원본 시작 날짜 사용
      const updateDate = event.repeat?.originalDate || event.date;

      // 수정 데이터 준비
      const updateData = {
        ...event,
        date: updateDate, // 원본 시작 날짜로 저장
        repeat: {
          type: event.repeat.type,
          interval: event.repeat.interval,
          endDate: event.repeat.endDate,
          // originalEventId, originalDate는 서버로 전송 안 함
        },
      };

      response = await fetch(`/api/events/${updateId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updateData),
      });
    } else {
      // 새 이벤트 등록
      response = await fetch('/api/events', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(eventData),
      });
    }

    // ...
  }
};
```

**수정 흐름**:
```
1. 사용자: 3월 31일 이벤트 클릭 → 수정 모달 열림
   - 이벤트 데이터: {id: "temp-2", date: "2025-03-31", repeat: {originalEventId: "original-123", originalDate: "2025-01-31"}}

2. 사용자: "매월 → 매주" 변경 후 저장

3. saveEvent 호출:
   - updateId = "original-123" (originalEventId 사용)
   - updateDate = "2025-01-31" (originalDate 사용)
   - updateData = {id: "original-123", date: "2025-01-31", repeat: {type: "weekly", ...}}

4. PUT /api/events/original-123 호출 ✅
   - 서버: 원본 이벤트 찾음 → 수정 성공

5. fetchEvents 호출:
   - 원본 이벤트: {id: "original-123", date: "2025-01-31", repeat: {type: "weekly"}}
   - 펼치기: 매주 수요일(1/31 시작 요일) 이벤트들 생성
```

## 📊 동작 예시

### 예시 1: 매월 → 매주 변경

**초기 상태** (DB):
```json
{
  "id": "event-001",
  "title": "팀 회의",
  "date": "2025-01-31",
  "repeat": {"type": "monthly", "interval": 1}
}
```

**화면 표시** (펼쳐진 이벤트):
```
✅ 1월 31일 (금)
✅ 3월 31일 (월)
✅ 5월 31일 (토)
✅ 7월 31일 (목)
✅ 8월 31일 (일)
...
```

**수정 동작**:
```
1. 사용자: 3월 31일 이벤트 클릭
2. 수정 모달: "매월 → 매주" 변경
3. 저장 클릭
4. 내부 동작:
   - updateId = "event-001" (원본 ID)
   - updateDate = "2025-01-31" (원본 시작 날짜)
   - PUT /api/events/event-001
   - Body: {date: "2025-01-31", repeat: {type: "weekly", interval: 1}}

5. DB 업데이트:
   {
     "id": "event-001",
     "date": "2025-01-31",
     "repeat": {"type": "weekly", "interval": 1}
   }

6. 화면 갱신 (매주 금요일로 펼침):
   ✅ 2025-01-31 (금)
   ✅ 2025-02-07 (금)
   ✅ 2025-02-14 (금)
   ✅ 2025-02-21 (금)
   ...
```

### 예시 2: 제목만 변경

**초기 상태**:
```json
{
  "id": "event-002",
  "title": "운동",
  "date": "2025-10-01",
  "repeat": {"type": "daily", "interval": 1}
}
```

**수정 동작**:
```
1. 사용자: 10월 5일 이벤트 클릭
2. 제목 변경: "운동" → "헬스장"
3. 저장 클릭
4. 내부 동작:
   - updateId = "event-002"
   - updateDate = "2025-10-01"
   - PUT /api/events/event-002
   - Body: {title: "헬스장", date: "2025-10-01", repeat: {type: "daily", ...}}

5. 전체 시리즈의 제목이 "헬스장"으로 변경됨 ✅
```

## 🎯 해결된 문제

### Before (수정 전)
```
❌ 펼쳐진 이벤트 수정 시 임시 ID 사용
❌ PUT /api/events/temp-2 → 404 오류
❌ 반복 유형 변경 불가능
❌ 전체 시리즈가 아닌 단일 이벤트만 수정
```

### After (수정 후)
```
✅ 원본 이벤트 ID 사용
✅ PUT /api/events/original-123 → 성공
✅ 반복 유형 변경 가능 (매월 → 매주)
✅ 전체 시리즈가 한 번에 수정됨
✅ 원본 시작 날짜로 저장하여 일관성 유지
```

## 💡 학습 내용

### 핵심 개념: Virtual vs Persistent ID

**Virtual ID (임시 ID)**:
- 화면 표시를 위해 클라이언트에서 생성
- 각 렌더링마다 변경될 수 있음
- DB에 저장되지 않음
- 예: `temp-1`, `temp-2`, `generated-uuid-...`

**Persistent ID (영구 ID)**:
- DB에 실제로 저장된 ID
- 수정/삭제 시 사용해야 함
- 변경되지 않음
- 예: `original-123`, `event-001`

**원칙**:
- **표시**: Virtual ID 사용 가능 (각 이벤트 구분용)
- **수정/삭제**: 반드시 Persistent ID 사용

### 메타데이터 추적 패턴

**문제**: 펼쳐진 데이터가 어디서 왔는지 추적 필요

**해결**: 원본 정보를 메타데이터로 저장
```typescript
{
  id: "virtual-id",        // 표시용
  data: "expanded-data",   // 펼쳐진 데이터
  metadata: {
    originalId: "...",     // 원본 ID
    originalDate: "...",   // 원본 기준일
  }
}
```

**적용**:
- 반복 일정: `originalEventId`, `originalDate`
- 그룹화된 데이터: `groupId`, `parentId`
- 계산된 데이터: `sourceId`, `baseValue`

### 데이터 일관성 유지

**원칙**: 원본 데이터의 기준점 유지

**잘못된 방식**:
```typescript
// ❌ 펼쳐진 날짜로 저장
PUT /api/events/123
Body: {date: "2025-03-31", repeat: {type: "monthly"}}
// 문제: 3월 31일이 기준일이 되어버림
```

**올바른 방식**:
```typescript
// ✅ 원본 시작 날짜로 저장
PUT /api/events/123
Body: {date: "2025-01-31", repeat: {type: "monthly"}}
// 1월 31일이 기준일로 유지됨
```

## 🧪 테스트 결과

```
✅ 반복 일정 테스트: 16개 모두 통과
✅ Lint: 오류 0개
✅ 수정 기능: 정상 작동
   - 매월 → 매주 변경 가능
   - 매주 → 매일 변경 가능
   - 반복 유형 자유롭게 변경 가능
```

## 📝 추가 고려사항

### 단일 이벤트 vs 시리즈 수정

**현재 구현**: 펼쳐진 이벤트 중 하나를 수정하면 전체 시리즈 수정

**향후 개선 가능**:
1. "이 이벤트만 수정" vs "전체 시리즈 수정" 옵션 제공
2. 특정 이벤트만 예외 처리 (예: 이번 주만 시간 변경)

**현재는 Google Calendar와 유사하게 전체 시리즈 수정으로 동작**

### 삭제 동작

**현재**: 펼쳐진 이벤트 중 하나 삭제 → 전체 시리즈 삭제
```typescript
const deleteId = eventToDelete?.repeat?.originalEventId || id;
```

**일관성**: 수정과 동일한 패턴

## ✅ 최종 확인

```
✅ 반복 일정 수정 가능
✅ 매월 → 매주 변경 성공
✅ 원본 이벤트 ID로 저장
✅ 원본 시작 날짜 유지
✅ 전체 시리즈 일괄 수정
✅ 모든 테스트 통과
```

이제 사용자님께서 31일 매월 반복 일정을 등록하고, 나중에 "매월 → 매주"로 변경해도 정상적으로 저장됩니다! 🎉

